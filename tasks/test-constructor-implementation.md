# Задача: Реализация конструктора тестов с PDF генерацией

## Описание задачи
Создать полноценный конструктор тестов с возможностью генерации стандартизированных PDF бланков для точного распознавания ИИ. Сохранить весь существующий функционал сочинений.

## Технические требования

### 1. Архитектурные принципы
- ✅ Сохранить весь функционал сочинений без изменений
- ✅ Все изменения должны быть аддитивными (не breaking changes)
- ✅ Обратная совместимость с существующими проверками
- ✅ Разделение логики: тесты (новый флоу) vs сочинения (существующий)

### 2. Пользовательский флоу

#### Создание теста:
1. Пользователь заходит на главную страницу dashboard
2. Нажимает "Создать тест" → переход на `/dashboard/test-builder`
3. В конструкторе создает вопросы с вариантами A,B,C,D
4. Указывает правильные ответы
5. Скачивает PDF бланк в стандартизированном формате

#### Создание проверки для теста:
1. Пользователь создает проверку, выбирает `workType === 'test'`
2. Видит упрощенный интерфейс: только критерии оценки
3. Получает напоминание использовать стандартный бланк
4. Загружает фотографии заполненных бланков
5. ИИ точно распознает ответы по стандартному формату

### 3. Компоненты для реализации

#### `/dashboard/test-builder/page.tsx`
- Новая страница конструктора тестов
- Интеграция с `TestConstructor.tsx`

#### `components/TestConstructor.tsx`
- Визуальный редактор вопросов
- Поддержка типов: одиночный выбор, множественный выбор
- Настройка вариантов ответов (A,B,C,D или 1,2,3,4)
- Предварительный просмотр теста
- Экспорт в PDF

#### Обновления в `CheckCreationStep2.tsx`
- Условная логика для `workType === 'test'`:
  - Убрать компоненты ввода ответов (`VariantManager`, `answers`)
  - Оставить только `GradingCriteria`
  - Добавить UI-подсказку о использовании стандартного бланка

#### `app/api/generate-test-pdf/route.ts`
- API для генерации PDF бланков
- Интеграция с jsPDF или Puppeteer
- Стандартизированный формат с:
  - Четкими кружочками для ответов
  - Крупной нумерацией вопросов
  - QR-кодом или ID теста
  - Достаточным пространством для заполнения

### 4. Обновление ИИ промпта
- В `lib/openrouter.ts` расширить логику для `checkType === 'test'`
- Специальные инструкции для стандартных бланков:
  - Распознавание закрашенных кружочков
  - Игнорирование зачеркнутых ответов
  - Обработка только финального выбора
  - Точная идентификация по позиции элементов

### 5. Типы данных

#### Новые TypeScript интерфейсы:
```typescript
interface TestQuestion {
  id: string
  question: string
  type: 'single' | 'multiple'
  options: Array<{
    id: string
    text: string
    isCorrect: boolean
  }>
}

interface GeneratedTest {
  id: string
  title: string
  questions: TestQuestion[]
  createdAt: string
}

interface PDFGenerationRequest {
  testId: string
  questions: TestQuestion[]
  format: 'A4' | 'Letter'
  answerType: 'circles' | 'squares'
}
```

### 6. База данных (если потребуется)
```sql
-- Опциональная таблица для сохранения созданных тестов
CREATE TABLE generated_tests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT NOT NULL,
  title TEXT NOT NULL,
  questions JSONB NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## Этапы реализации

### Этап 1: Подготовка
- [x] Создать файл задач
- [ ] Коммит текущего состояния
- [ ] Push в репозиторий

### Этап 2: Конструктор тестов
- [ ] Создать страницу `/dashboard/test-builder`
- [ ] Реализовать `TestConstructor.tsx`
- [ ] Добавить типы данных для тестов

### Этап 3: PDF генерация
- [ ] Установить библиотеку для PDF (jsPDF)
- [ ] Создать API `/api/generate-test-pdf`
- [ ] Реализовать стандартизированный шаблон

### Этап 4: Упрощение создания проверок
- [ ] Обновить `CheckCreationStep2.tsx` для тестов
- [ ] Убрать ввод ответов для `workType === 'test'`
- [ ] Добавить напоминание о стандартном бланке

### Этап 5: Оптимизация ИИ
- [ ] Обновить промпт в `lib/openrouter.ts`
- [ ] Добавить специальную логику для стандартных бланков
- [ ] Тестирование распознавания

### Этап 6: Интеграция и навигация
- [ ] Добавить кнопку "Создать тест" на dashboard
- [ ] Обновить навигационное меню
- [ ] Тестирование полного флоу

## Критерии успеха
- ✅ Пользователь может создать тест с вопросами и вариантами
- ✅ PDF генерируется в стандартизированном формате
- ✅ ИИ точно распознает ответы с PDF бланков
- ✅ Функционал сочинений работает без изменений
- ✅ Существующие проверки совместимы
- ✅ Интуитивный UX для создания и использования тестов

## Риски и митигация
- **Риск**: Сломать существующие проверки
  - **Митигация**: Все изменения аддитивные, тесты на совместимость
- **Риск**: ИИ плохо распознает PDF бланки
  - **Митигация**: Итеративная оптимизация промпта и формата
- **Риск**: Сложность генерации PDF
  - **Митигация**: Использование проверенных библиотек, простые шаблоны