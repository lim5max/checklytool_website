# План реализации основного функционала ChecklyTool

## Анализ требований из brief.txt

### Основные функции системы:
1. **Создание новых проверок** - пользователь может создавать "проверки" работ
2. **Управление вариантами** - указание количества вариантов контрольной работы
3. **Эталонные ответы** - загрузка изображений или ручной ввод правильных ответов
4. **Критерии оценки** - настройка оценок (2-5) в процентах от правильных ответов
5. **Сканирование работ** - камера для многостраничных работ учащихся
6. **ИИ распознавание** - отправка в OpenRouter (Gemini Flash) для анализа
7. **Результаты проверки** - оценка, вариант, количество правильных/неправильных ответов
8. **Управление ошибками** - возможность перезагрузки фото при ошибке распознавания
9. **Статистика** - базовая статистика по результатам (средний балл)
10. **Личный кабинет** - история всех проверок с доступом к результатам

### Технические требования:
- **Mobile First** подход (основное использование с телефона)
- **Современный, чистый интерфейс** с минимальной когнитивной нагрузкой
- **Большие кнопки** для мобильных устройств
- **Framer Motion** анимации для отзывчивости
- **Обработка сбоев** API OpenRouter
- **Сохранность данных** в личном кабинете

## Детальный план этапов реализации

### ЭТАП 1: Подготовка базы данных
#### Задача 1.1: Создание схемы базы данных
- [ ] Таблица `user_profiles` (профили пользователей для админки)
- [ ] Таблица `checks` (проверки/контрольные работы)
- [ ] Таблица `grading_criteria` (критерии оценки)
- [ ] Таблица `check_variants` (варианты контрольной)
- [ ] Таблица `student_submissions` (работы учеников)
- [ ] Таблица `evaluation_results` (результаты проверки)
- [ ] Таблица `check_statistics` (статистика по проверкам)
- [ ] Настройка RLS (Row Level Security) с админскими правами
- [ ] Функции автоматического создания профилей при первом логине

#### Задача 1.2: Создание TypeScript типов
- [ ] Интерфейсы для всех таблиц базы данных
- [ ] Типы для форм создания проверок
- [ ] Типы для результатов ИИ анализа
- [ ] Валидационные схемы Zod

### ЭТАП 2: API endpoints
#### Задача 2.1: CRUD операции для проверок
- [ ] POST `/api/checks` - создание новой проверки
- [ ] GET `/api/checks` - список проверок пользователя
- [ ] GET `/api/checks/[id]` - детали конкретной проверки
- [ ] PUT `/api/checks/[id]` - обновление проверки
- [ ] DELETE `/api/checks/[id]` - удаление проверки

#### Задача 2.2: Управление пользователями и админка
- [ ] POST `/api/users/profile` - создание/обновление профиля при логине
- [ ] GET `/api/admin/users` - список всех пользователей (только для админа)
- [ ] PUT `/api/admin/users/[id]/role` - изменение роли пользователя
- [ ] GET `/api/admin/stats` - админская статистика

#### Задача 2.3: Управление вариантами и ответами
- [ ] POST `/api/checks/[id]/variants` - добавление варианта
- [ ] POST `/api/checks/[id]/variants/[variantId]/answers` - загрузка эталонных ответов
- [ ] PUT `/api/checks/[id]/criteria` - настройка критериев оценки

#### Задача 2.4: Обработка работ учеников
- [ ] POST `/api/checks/[id]/submissions` - загрузка работы ученика
- [ ] POST `/api/submissions/[id]/evaluate` - отправка на ИИ проверку
- [ ] GET `/api/submissions/[id]/results` - получение результатов

#### Задача 2.5: Интеграция с OpenRouter
- [ ] Функция отправки изображений в Gemini Flash
- [ ] Обработка ответов от ИИ
- [ ] Retry механизм при сбоях API
- [ ] Парсинг результатов распознавания

### ЭТАП 3: UI компоненты основного функционала
#### Задача 3.1: Создание новой проверки
- [ ] Форма основных параметров проверки
- [ ] Выбор количества вариантов
- [ ] Настройка критериев оценки (2-5)
- [ ] Компонент прогресса создания

#### Задача 3.2: Управление вариантами
- [ ] Список вариантов контрольной работы
- [ ] Загрузка изображений эталонных ответов
- [ ] Ручной ввод правильных ответов
- [ ] Превью загруженных изображений

#### Задача 3.3: Сканирование работ учеников
- [ ] Компонент камеры для сканирования
- [ ] Многостраничная загрузка работ
- [ ] Подсказки для качественных фото
- [ ] Предварительный просмотр отсканированного

#### Задача 3.4: Результаты проверки
- [ ] Карточка результата с оценкой
- [ ] Отображение правильных/неправильных ответов
- [ ] Определение варианта работы
- [ ] Возможность добавления ФИО ученика
- [ ] Кнопка перезагрузки при ошибке

### ЭТАП 4: Страницы приложения
#### Задача 4.1: Дашборд с проверками
- [ ] Список всех проверок пользователя
- [ ] Карточки проверок с базовой статистикой
- [ ] Кнопка создания новой проверки
- [ ] Поиск и фильтрация проверок

#### Задача 4.2: Страница создания проверки
- [ ] Мастер создания проверки (step-by-step)
- [ ] Валидация всех полей формы
- [ ] Сохранение прогресса
- [ ] Превью настроек перед созданием

#### Задача 4.3: Страница проверки работ
- [ ] Интерфейс сканирования/загрузки
- [ ] Очередь работ на проверку
- [ ] Статус обработки каждой работы
- [ ] Результаты проверенных работ

#### Задача 4.4: Админская панель (только для админов)
- [ ] Список всех пользователей системы
- [ ] Статистика по пользователям и использованию
- [ ] Управление ролями пользователей
- [ ] Мониторинг активности в системе

#### Задача 4.5: Страница результатов
- [ ] Детальная статистика по проверке
- [ ] Список всех проверенных работ
- [ ] Средний балл и распределение оценок
- [ ] Экспорт результатов

### ЭТАП 5: Mobile First оптимизация
#### Задача 5.1: Адаптивный дизайн
- [ ] Все компоненты адаптированы под мобильные экраны
- [ ] Большие кнопки для touch интерфейса
- [ ] Оптимизированная навигация для телефонов
- [ ] Минимизация количества шагов

#### Задача 5.2: Камера и файлы
- [ ] Оптимизация работы с камерой на мобильных
- [ ] Сжатие изображений перед загрузкой
- [ ] Поддержка различных форматов файлов
- [ ] Offline handling для медленного интернета

### ЭТАП 6: Анимации и UX
#### Задача 6.1: Framer Motion интеграция
- [ ] Плавные переходы между страницами
- [ ] Анимации загрузки и обработки
- [ ] Микро-взаимодействия в формах
- [ ] Feedback анимации для пользовательских действий

#### Задача 6.2: Loading states и feedback
- [ ] Скелетон загрузки для всех компонентов
- [ ] Прогресс-бары для длительных операций
- [ ] Toast уведомления для результатов
- [ ] Error states с возможностью retry

### ЭТАП 7: Тестирование и оптимизация
#### Задача 7.1: Функциональное тестирование
- [ ] Тестирование создания проверок
- [ ] Тестирование загрузки и обработки изображений
- [ ] Тестирование интеграции с OpenRouter
- [ ] Тестирование всех error случаев

#### Задача 7.2: Performance оптимизация
- [ ] Оптимизация загрузки изображений
- [ ] Lazy loading компонентов
- [ ] Caching стратегии для API
- [ ] Bundle size оптимизация

## Приоритеты разработки

### Высокий приоритет (MVP):
1. База данных и API для создания проверок
2. Базовая загрузка изображений
3. Интеграция с OpenRouter
4. Простой UI для создания проверки
5. Отображение результатов

### Средний приоритет:
1. Мультивариантность проверок
2. Расширенная статистика
3. Улучшенный UX камеры
4. Анимации и полироаание UI

### Низкий приоритет:
1. Экспорт результатов
2. Расширенная аналитика
3. Дополнительные форматы файлов
4. Advanced настройки критериев

## Технические детали

### Database Schema Preview:
```sql
-- Таблица профилей пользователей (для админки)
user_profiles (
  id UUID PRIMARY KEY,
  user_id TEXT UNIQUE NOT NULL, -- NextAuth user ID
  email TEXT NOT NULL,
  name TEXT,
  provider TEXT, -- google, yandex
  role TEXT DEFAULT 'user', -- user, admin
  total_checks INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW()
)

-- Основная таблица проверок
checks (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES profiles(id),
  title TEXT NOT NULL,
  description TEXT,
  variant_count INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT NOW()
)

-- Критерии оценки
grading_criteria (
  id UUID PRIMARY KEY,
  check_id UUID REFERENCES checks(id),
  grade INTEGER, -- 2, 3, 4, 5
  min_percentage INTEGER -- процент правильных ответов
)

-- Варианты работы
check_variants (
  id UUID PRIMARY KEY,
  check_id UUID REFERENCES checks(id),
  variant_number INTEGER,
  reference_answers JSONB -- структура с правильными ответами
)

-- Работы учеников
student_submissions (
  id UUID PRIMARY KEY,
  check_id UUID REFERENCES checks(id),
  student_name TEXT,
  images TEXT[], -- массив URL изображений
  status TEXT DEFAULT 'pending', -- pending, processing, completed, failed
  variant_detected INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
)

-- Результаты проверки
evaluation_results (
  id UUID PRIMARY KEY,
  submission_id UUID REFERENCES student_submissions(id),
  total_questions INTEGER,
  correct_answers INTEGER,
  incorrect_answers INTEGER,
  grade INTEGER,
  ai_response JSONB, -- полный ответ от ИИ
  created_at TIMESTAMP DEFAULT NOW()
)
```

### API Structure Preview:
```typescript
// Создание новой проверки
POST /api/checks
{
  title: string
  description?: string
  variantCount: number
  gradingCriteria: Array<{grade: number, minPercentage: number}>
}

// Загрузка работы ученика
POST /api/checks/[id]/submissions
{
  studentName?: string
  images: File[]
}

// Результат проверки
GET /api/submissions/[id]/results
{
  submissionId: string
  grade: number
  correctAnswers: number
  incorrectAnswers: number
  totalQuestions: number
  variantDetected: number
  details: AIAnalysisResult
}
```

Этот план обеспечивает поэтапную реализацию всех требований из brief.txt с фокусом на Mobile First подход и качественный UX.