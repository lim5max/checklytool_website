# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –û–ø–ª–∞—Ç–µ –∏ –ü–æ–¥–ø–∏—Å–∫–∞–º

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¢-–ë–∞–Ω–∫ API –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ —Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ–º –ø—Ä–æ–≤–µ—Ä–æ–∫.

## –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

### –¢–µ–∫—É—â–∏–µ —Ç–∞—Ä–∏—Ñ—ã:

1. **FREE (–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π)** - `3c8498ed-8093-44f8-97e3-b7ae4973c743`
   - 0 –ø—Ä–æ–≤–µ—Ä–æ–∫
   - –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
   - –†–∞–±–æ—Ç–∞ —Å —à–∞–±–ª–æ–Ω–∞–º–∏ —Ç–µ—Å—Ç–æ–≤

2. **PRO** - `7aae118b-6cac-418e-91e9-b73290b99100`
   - 300 –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ –º–µ—Å—è—Ü
   - –¶–µ–Ω–∞: 299 ‚ÇΩ/–º–µ—Å
   - –¢–µ—Å—Ç—ã –∏ —Å–æ—á–∏–Ω–µ–Ω–∏—è: **1 —Ä–∞–±–æ—Ç–∞ = 1 –ø—Ä–æ–≤–µ—Ä–∫–∞**
   - –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

## –°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–æ–∫

**–í–ê–ñ–ù–û:** –° –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–æ–∫ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞:

- ‚úÖ –¢–µ—Å—Ç—ã: **1 —Ä–∞–±–æ—Ç–∞ = 1 –ø—Ä–æ–≤–µ—Ä–∫–∞**
- ‚úÖ –°–æ—á–∏–Ω–µ–Ω–∏—è: **1 —Ä–∞–±–æ—Ç–∞ = 1 –ø—Ä–æ–≤–µ—Ä–∫–∞**

–†–∞–Ω–µ–µ —Ç–µ—Å—Ç—ã —Å—Ç–æ–∏–ª–∏ 0.5 –ø—Ä–æ–≤–µ—Ä–∫–∏, —Ç–µ–ø–µ—Ä—å –≤—Å–µ —Ä–∞–±–æ—Ç—ã —Å—Ç–æ—è—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ.

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—Ç–∏–ª?

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ `payment_orders`

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT
  po.order_id,
  po.status,
  po.amount,
  po.payment_id,
  po.created_at,
  po.updated_at,
  sp.display_name as plan_name
FROM payment_orders po
LEFT JOIN subscription_plans sp ON po.plan_id = sp.id
WHERE po.user_id = 'email@example.com'
ORDER BY po.created_at DESC;
```

**–°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–∞:**
- `paid` ‚úÖ - –æ–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- `pending` ‚è≥ - –æ–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã
- `failed` ‚ùå - –ø–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à–µ–ª
- `cancelled` üö´ - –ø–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–¥–ø–∏—Å–∫—É –∏ –±–∞–ª–∞–Ω—Å –ø—Ä–æ–≤–µ—Ä–æ–∫
SELECT
  up.email,
  up.check_balance,
  up.subscription_started_at,
  up.subscription_expires_at,
  sp.display_name as plan_name,
  sp.check_credits as plan_credits,
  sp.price,
  CASE
    WHEN up.subscription_expires_at > NOW() THEN '–ê–∫—Ç–∏–≤–Ω–∞'
    ELSE '–ò—Å—Ç–µ–∫–ª–∞'
  END as subscription_status
FROM user_profiles up
LEFT JOIN subscription_plans sp ON up.subscription_plan_id = sp.id
WHERE up.email = 'email@example.com';
```

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è –≤ `user_profiles`:**
- `subscription_plan_id` - ID –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- `check_balance` - —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –ø—Ä–æ–≤–µ—Ä–æ–∫
- `subscription_expires_at` - –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
- `subscription_started_at` - –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—Å–∫–∏

### 3. –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–ª–∞—Ç

```sql
-- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
SELECT
  po.order_id,
  up.email,
  sp.display_name as plan_name,
  po.amount / 100.0 as amount_rub,
  po.payment_id,
  po.created_at as payment_date
FROM payment_orders po
JOIN user_profiles up ON po.user_id = up.user_id
LEFT JOIN subscription_plans sp ON po.plan_id = sp.id
WHERE po.status = 'paid'
ORDER BY po.created_at DESC
LIMIT 50;
```

### 4. –ò—Å—Ç–æ—Ä–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫

```sql
-- –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Å–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
SELECT
  cuh.created_at,
  cuh.check_type,
  cuh.credits_used,
  c.title as check_name,
  ss.student_name
FROM check_usage_history cuh
LEFT JOIN checks c ON cuh.check_id = c.id
LEFT JOIN student_submissions ss ON cuh.submission_id = ss.id
WHERE cuh.user_id = 'email@example.com'
ORDER BY cuh.created_at DESC
LIMIT 20;
```

## –ü—Ä–æ—Ü–µ—Å—Å –æ–ø–ª–∞—Ç—ã

### –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞

**Endpoint:** `POST /api/payment/init`

```typescript
// –ó–∞–ø—Ä–æ—Å
{
  "planId": "7aae118b-6cac-418e-91e9-b73290b99100"
}

// –û—Ç–≤–µ—Ç
{
  "orderId": "ORDER_1760123436254_mmg6at7",
  "paymentUrl": "https://pay.tbank.ru/GAe0WsJX"
}
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `payment_orders` —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `pending`.

### –®–∞–≥ 2: –û–ø–ª–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ `paymentUrl` –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –æ–ø–ª–∞—Ç—É –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –¢-–ë–∞–Ω–∫.

### –®–∞–≥ 3: Webhook –æ—Ç –¢-–ë–∞–Ω–∫

**Endpoint:** `POST /api/payment/webhook`

–¢-–ë–∞–Ω–∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ –ø–ª–∞—Ç–µ–∂–∞:

```typescript
{
  "OrderId": "ORDER_1760123436254_mmg6at7",
  "Status": "CONFIRMED",
  "Success": true,
  "PaymentId": "7174629320"
}
```

### –®–∞–≥ 4: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ (`Status: 'CONFIRMED'` –∏ `Success: true`):

1. **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `payment_orders`:**
   - `status` ‚Üí `'paid'`
   - `payment_id` ‚Üí ID –ø–ª–∞—Ç–µ–∂–∞ –∏–∑ –¢-–ë–∞–Ω–∫

2. **–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `user_profiles`:**
   - `subscription_plan_id` ‚Üí ID –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∞
   - `check_balance` ‚Üí –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏–∑ –ø–ª–∞–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 300)
   - `subscription_expires_at` ‚Üí –¥–∞—Ç–∞ —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π

3. **–°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `check_usage_history`:**
   - –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `credits_used` = –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

## Webhook-—Å—Ç–∞—Ç—É—Å—ã –¢-–ë–∞–Ω–∫

**–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞:**
- `CONFIRMED` + `Success: true` ‚Üí —Å—Ç–∞—Ç—É—Å `paid`

**–û—Ç–º–µ–Ω–∞/–æ—à–∏–±–∫–∞:**
- `REJECTED`, `DEADLINE_EXPIRED`, `AUTH_FAIL`, `ATTEMPTS_EXPIRED` ‚Üí —Å—Ç–∞—Ç—É—Å `failed`

**–û—Ç–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:**
- `CANCELED` ‚Üí —Å—Ç–∞—Ç—É—Å `cancelled`

## –õ–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫

–§–∞–π–ª: `lib/subscription.ts`

```typescript
export function calculateCreditsNeeded(
  checkType: 'test' | 'essay',
  pagesCount: number
): number {
  // –ò —Ç–µ—Å—Ç—ã, –∏ —Å–æ—á–∏–Ω–µ–Ω–∏—è —Å—á–∏—Ç–∞—é—Ç—Å—è –æ–¥–∏–Ω–∞–∫–æ–≤–æ: 1 —Ä–∞–±–æ—Ç–∞ = 1 –ø—Ä–æ–≤–µ—Ä–∫–∞
  return 1
}
```

–ü—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ä–∞–±–æ—Ç—ã –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è RPC-—Ñ—É–Ω–∫—Ü–∏—è `deduct_check_credits` –≤ Supabase, –∫–æ—Ç–æ—Ä–∞—è:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å –±–∞–ª–∞–Ω—Å–∞
2. –°–ø–∏—Å—ã–≤–∞–µ—Ç 1 –ø—Ä–æ–≤–µ—Ä–∫—É
3. –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ `check_usage_history`

## –ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã

### –ö–∞–∫ –≤—Ä—É—á–Ω—É—é –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é?

```sql
-- –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å PRO –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
UPDATE user_profiles
SET
  subscription_plan_id = '7aae118b-6cac-418e-91e9-b73290b99100',
  check_balance = 300,
  subscription_expires_at = NOW() + INTERVAL '30 days',
  subscription_started_at = NOW()
WHERE email = 'email@example.com';
```

### –ö–∞–∫ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø—Ä–æ–≤–µ—Ä–æ–∫ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞?

```sql
-- –î–æ–±–∞–≤–∏—Ç—å 50 –ø—Ä–æ–≤–µ—Ä–æ–∫ –∫ —Ç–µ–∫—É—â–µ–º—É –±–∞–ª–∞–Ω—Å—É
UPDATE user_profiles
SET check_balance = check_balance + 50
WHERE email = 'email@example.com';

-- –ó–∞–ø–∏—Å–∞—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
INSERT INTO check_usage_history (user_id, credits_used, check_type)
VALUES ('email@example.com', -50, 'test');
```

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —É –∫–æ–≥–æ –∏—Å—Ç–µ–∫–ª–∞ –ø–æ–¥–ø–∏—Å–∫–∞?

```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∏—Å—Ç–µ–∫—à–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π
SELECT
  email,
  subscription_expires_at,
  check_balance
FROM user_profiles
WHERE subscription_expires_at < NOW()
  AND subscription_plan_id IS NOT NULL
ORDER BY subscription_expires_at DESC;
```

### –ö–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –æ–ø–ª–∞—Ç–∞–º?

```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ–ø–ª–∞—Ç–∞–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü
SELECT
  DATE(po.created_at) as payment_date,
  COUNT(*) as payments_count,
  COUNT(CASE WHEN po.status = 'paid' THEN 1 END) as successful_payments,
  SUM(CASE WHEN po.status = 'paid' THEN po.amount ELSE 0 END) / 100.0 as total_revenue_rub
FROM payment_orders po
WHERE po.created_at >= NOW() - INTERVAL '30 days'
GROUP BY DATE(po.created_at)
ORDER BY payment_date DESC;
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook** - –∫–∞–∂–¥—ã–π webhook –æ—Ç –¢-–ë–∞–Ω–∫ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `verifyWebhookToken()` –≤ `lib/tbank.ts`
2. **RLS (Row Level Security)** - –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∑–∞—â–∏—â–µ–Ω—ã –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ RLS –≤ Supabase
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Service Role** - –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ service role –¥–ª—è –æ–±—Ö–æ–¥–∞ RLS

## –§–∞–π–ª—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–ø–ª–∞—Ç–æ–π

- `components/subscription-modal.tsx` - UI –º–æ–¥–∞–ª –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞
- `app/api/payment/init/route.ts` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞
- `app/api/payment/webhook/route.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç –¢-–ë–∞–Ω–∫
- `app/api/subscription/plans/route.ts` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç–∞—Ä–∏—Ñ–æ–≤
- `lib/subscription.ts` - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫
- `lib/tbank.ts` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¢-–ë–∞–Ω–∫ API
