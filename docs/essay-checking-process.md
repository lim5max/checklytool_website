# Процесс Проверки Сочинений

## Обзор

Система проверки сочинений использует двухэтапный подход с применением AI-моделей через OpenRouter API для максимальной точности распознавания и оценки работ учеников.

---

## Этапы Проверки

### 1. Предобработка Изображений

**Локация**: `lib/upload-submissions.ts:143-223`

**Функция**: `convertToBlackAndWhite()`

**Процесс**:
- Конвертация изображения в черно-белое (grayscale) с применением weighted average: `0.299R + 0.587G + 0.114B`
- Увеличение контраста на 50% (`contrastFactor = 1.5`) для четкости текста
- Усиление светлых участков (highlights) на 20% (`highlightBoost = 1.2`) для лучшей читаемости бумаги
- Сохранение в JPEG с качеством 90% для минимизации артефактов

**Параметры**:
```typescript
contrastFactor = 1.5       // Увеличение контраста
highlightBoost = 1.2       // Усиление светлых участков
highlightThreshold = 128   // Порог для highlights (0-255)
```

**Применяется**: Только для сочинений (`checkType === 'essay'`)

---

### 2. Отправка и Проверка

**Локация**: `app/api/submissions/[id]/evaluate/route.ts`

**API Endpoint**: `POST /api/submissions/[id]/evaluate`

**Timeout**: 60 секунд (для обработки больших изображений)

**Процесс**:
1. Валидация прав пользователя
2. Обновление signed URLs для изображений (24 часа)
3. Списание кредитов (по количеству страниц)
4. Вызов двухэтапной проверки AI
5. Сохранение результатов в базу данных

---

## AI-модели и Двухэтапная Проверка

### ЭТАП 1: Распознавание Текста

**Локация**: `lib/openrouter.ts:547-688`

**Модель**: `google/gemini-2.5-flash`

**Назначение**: Чтение и расшифровка рукописного текста

**Параметры**:
```typescript
model: 'google/gemini-2.5-flash'
max_tokens: 4000
temperature: 0.1  // Низкая температура для точного чтения
```

**Промпт (System)**:
```
Ты - эксперт по распознаванию рукописного текста.
Твоя задача - прочитать рукописный текст и расшифровать его в ЧИТАЕМЫЙ вид.

ПРАВИЛА РАСШИФРОВКИ:
1. ИСПРАВЛЯЙ неразборчивый почерк, используя контекст
2. Используй КОНТЕКСТ предложения для расшифровки
3. Сохраняй РЕАЛЬНЫЕ орфографические и грамматические ошибки
4. Если слово СОВСЕМ невозможно распознать: [неразборчиво]
5. Сделай текст ЧИТАЕМЫМ для второго AI
```

**Результат**:
```json
{
  "raw_text": "Расшифрованный текст сочинения",
  "confidence": 0.95,
  "student_name": null
}
```

**Особенности**:
- Исправляет неразборчивый почерк
- Разделяет слипшиеся слова
- Сохраняет настоящие ошибки ученика
- Проверка на неподходящий контент (селфи, случайные предметы)

---

### ЭТАП 2: Проверка Ошибок и Оценка

**Локация**: `lib/openrouter.ts:691-878`

**Модель**: `google/gemini-2.5-flash`

**Назначение**: Проверка текста на ошибки и выставление оценки

**Параметры**:
```typescript
model: 'google/gemini-2.5-flash'
max_tokens: 4000
temperature: 0.15  // Низкая температура для объективной оценки
```

**Промпт (System)**:
```
Ты - преподаватель, проверяешь сочинения учеников.
Тебе предоставлен ДОСЛОВНО расшифрованный текст сочинения.
Твоя задача - ПРОВЕРИТЬ этот текст на ошибки и ОЦЕНИТЬ по критериям.

ОПРЕДЕЛИ ЯЗЫК текста (русский или английский) и проверяй согласно правилам.
```

**Классификация Ошибок (Русский)**:
1. **ОРФОГРАФИЧЕСКИЕ**: неправильное написание слов
2. **ПУНКТУАЦИОННЫЕ**: неправильная постановка знаков препинания
3. **ГРАММАТИЧЕСКИЕ**: нарушение грамматических норм
4. **РЕЧЕВЫЕ**: плеоназм, тавтология
5. **СИНТАКСИЧЕСКИЕ**: нарушение структуры предложения

**Классификация Ошибок (Английский)**:
1. **SPELLING ERRORS**: incorrect word spelling
2. **PUNCTUATION ERRORS**: incorrect punctuation
3. **GRAMMAR ERRORS**: subject-verb agreement, tense errors
4. **WORD CHOICE ERRORS**: affect vs effect
5. **SYNTAX ERRORS**: sentence structure problems

**Результат**:
```json
{
  "variant_detected": 1,
  "confidence_score": 0.95,
  "student_name": null,
  "total_questions": 1,
  "essay_analysis": {
    "structure": {
      "has_introduction": true,
      "has_body": true,
      "has_conclusion": true,
      "score": 0.9
    },
    "logic": {
      "coherent": true,
      "clear_arguments": true,
      "score": 0.8
    },
    "errors": {
      "spelling_errors": 2,
      "punctuation_errors": 1,
      "grammar_errors": 0,
      "speech_errors": 0,
      "syntax_errors": 0,
      "total_errors": 3,
      "examples": [
        "орфографическая - несмотря вместо не смотря",
        "пунктуационная - отсутствует запятая перед союзом что"
      ]
    },
    "content_quality": "хорошее раскрытие темы примеры уместны",
    "final_grade": 4
  },
  "answers": {
    "1": {
      "detected_answer": "ПОЛНЫЙ ТЕКСТ СОЧИНЕНИЯ",
      "confidence": 0.95
    }
  },
  "additional_notes": "комментарии к работе"
}
```

---

## Критерии Оценки

**По умолчанию**:
- **5 баллов**: структура соблюдена, логика ясная, ошибок мало или совсем нет (≤2 грамматических)
- **4 балла**: структура есть, логика понятна, ошибок немного (3-6 грамматических)
- **3 балла**: структура нарушена, логика сбивается, ошибок много (>6)
- **2 балла**: структура отсутствует, логики нет, ошибок очень много

**Кастомные критерии**: Можно задать через `essay_grading_criteria` в таблице `checks`

---

## Обработка Результатов

**Локация**: `app/api/submissions/[id]/evaluate/route.ts:635-668`

**Процесс**:
1. Получение оценки AI (`essay_analysis.final_grade`)
2. Конвертация в процентную шкалу: `percentage = (grade / 5) * 100`
3. Валидация оценки по критериям
4. Сохранение в таблицу `evaluation_results`

**Структура сохраненных данных**:
```typescript
{
  submission_id: string
  total_questions: 1
  correct_answers: grade  // для сочинений = оценка (2-5)
  incorrect_answers: 5 - grade
  percentage_score: number
  final_grade: number
  variant_used: 1
  detailed_answers: Record<string, object>
  ai_response: object
  confidence_score: number
  essay_analysis: {
    structure: object
    logic: object
    errors: object
    content_quality: string
    final_grade: number
  }
  additional_notes: string
}
```

---

## Обработка Ошибок

**Типы ошибок**:

1. **inappropriate_content**: Неподходящие изображения (селфи, пустые страницы)
   - Статус: `400 Bad Request`
   - Submission status: `failed`
   - Не списываются кредиты

2. **insufficient_credits**: Недостаточно кредитов
   - Статус: `402 Payment Required`
   - Submission status: не меняется

3. **processing_error**: Ошибка обработки AI
   - Статус: `500 Internal Server Error`
   - Submission status: `failed`
   - Сохраняется `error_details` для отладки

---

## Retry Механизм

**Локация**: `lib/openrouter.ts:437-463`

**Параметры**:
- Максимальное количество попыток: 3
- Exponential backoff: 1s, 2s, 4s
- Применяется для сетевых ошибок и временных проблем API

---

## Особенности Реализации

1. **Обновление Signed URLs**: Перед отправкой AI создаются свежие signed URLs (24 часа) для надежного доступа к изображениям

2. **Уникальные Request IDs**: Каждый запрос имеет уникальный ID для предотвращения кэширования: `analysis_${Date.now()}_${random}`

3. **JSON Sanitization**: Автоматическая очистка некорректного JSON от AI:
   - Удаление control characters
   - Escape неэкранированных кавычек
   - Исправление незакрытых объектов при truncation

4. **Fallback для Текста**: Если Flash не вернул полный текст, используется текст от первого этапа (Pro)

5. **Защита от Валидации**: Проверка всех обязательных полей перед сохранением

---

## Производительность

**Timing (примерно)**:
- Предобработка изображений (клиент): ~100-300ms на изображение
- Этап 1 (Gemini Flash): ~3-5 секунд
- Этап 2 (Gemini Flash): ~3-5 секунд
- **Общее время**: ~6-12 секунд на проверку

**Ограничения**:
- Максимум 5 изображений на проверку
- Таймаут API: 60 секунд
- Max tokens: 4000 на каждый этап

---

## Планы Развития

- [ ] Добавить поддержку большего количества изображений
- [ ] Кэширование промежуточных результатов для retry
- [ ] Поддержка проверки на других языках (немецкий, французский)
- [ ] Детальная статистика по типам ошибок
- [ ] Сравнение с предыдущими работами ученика
