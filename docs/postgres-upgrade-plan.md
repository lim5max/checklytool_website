# План Обновления PostgreSQL

## Текущая Ситуация

**Текущая версия**: `supabase-postgres-17.4.1.074`
**Доступные патчи безопасности**: Да
**Приоритет**: СРЕДНИЙ
**Уровень риска**: WARN

Система обнаружила, что текущая версия PostgreSQL имеет доступные патчи безопасности, которые необходимо применить.

---

## Важная Информация

### Что Обновляется?

Supabase использует кастомизированную версию PostgreSQL с дополнительными расширениями и оптимизациями. Обновление включает:

- Патчи безопасности PostgreSQL
- Обновления расширений (pg_graphql, pgsodium, pgvector и др.)
- Оптимизации производительности
- Исправления багов

### Риски

**НИЗКИЙ РИСК**, но требует планирования:

1. **Временный downtime**: 5-15 минут
2. **Возможные проблемы совместимости**: Маловероятно для minor updates
3. **Откат сложен**: Требуется backup

---

## Предварительная Подготовка

### 1. Создание Backup

**КРИТИЧЕСКИ ВАЖНО!** Создайте полный backup базы данных перед обновлением.

#### Через Supabase Dashboard:

1. Перейдите в раздел **Database** → **Backups**
2. Нажмите **Create backup**
3. Дождитесь завершения

#### Через CLI:

```bash
# Установить Supabase CLI (если еще не установлен)
npm install -g supabase

# Логин
supabase login

# Создать backup
supabase db dump --db-url "postgresql://postgres:[YOUR-PASSWORD]@db.[YOUR-PROJECT-REF].supabase.co:5432/postgres" > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 2. Тестирование на Staging

**НАСТОЯТЕЛЬНО РЕКОМЕНДУЕТСЯ** протестировать обновление на staging окружении:

1. Создайте клон проекта в Supabase
2. Восстановите backup на клон
3. Выполните обновление
4. Протестируйте все критические функции
5. Проверьте миграции

### 3. План Отката

Подготовьте план отката на случай проблем:

1. Backup базы данных (см. выше)
2. Документация текущей версии
3. Список критических функций для проверки
4. Контакты поддержки Supabase

---

## Процесс Обновления

### Через Supabase Dashboard (Рекомендуется)

1. **Перейдите в Settings**:
   - Откройте [Supabase Dashboard](https://app.supabase.com)
   - Выберите ваш проект
   - Перейдите в **Settings** → **Infrastructure**

2. **Найдите раздел Database**:
   - Найдите информацию о версии PostgreSQL
   - Если доступно обновление, появится кнопка **Upgrade**

3. **Запланируйте обновление**:
   - Выберите время с минимальной нагрузкой (ночь, выходные)
   - Убедитесь, что backup создан
   - Нажмите **Upgrade**

4. **Дождитесь завершения**:
   - Процесс займет 5-15 минут
   - НЕ закрывайте страницу
   - База будет недоступна во время обновления

### Через Support Ticket (Альтернатива)

Если автоматическое обновление недоступно:

1. Откройте ticket в [Supabase Support](https://supabase.com/support)
2. Укажите:
   - Project ID
   - Текущую версию PostgreSQL
   - Желаемое время обновления
3. Дождитесь подтверждения от команды Supabase

---

## Пост-Обновление: Проверки

### 1. Базовые Проверки

```sql
-- Проверить версию PostgreSQL
SELECT version();

-- Проверить доступные расширения
SELECT * FROM pg_available_extensions
WHERE name IN ('uuid-ossp', 'pg_graphql', 'pgsodium', 'pgvector')
ORDER BY name;

-- Проверить статус репликации (если используется)
SELECT * FROM pg_stat_replication;
```

### 2. Проверка Функций

```sql
-- Проверить все пользовательские функции
SELECT
	proname as function_name,
	prosrc as source_code
FROM pg_proc
WHERE pronamespace = 'public'::regnamespace
ORDER BY proname;

-- Выполнить тестовый вызов критических функций
SELECT get_dashboard_stats('test_user_id');
SELECT deduct_check_credits('test_user_id', 1);
```

### 3. Проверка Индексов и Производительности

```sql
-- Проверить все индексы
SELECT
	schemaname,
	tablename,
	indexname,
	indexdef
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY tablename, indexname;

-- Обновить статистику
ANALYZE;

-- Проверить производительность
EXPLAIN ANALYZE
SELECT * FROM checks WHERE user_id = 'test@example.com' ORDER BY created_at DESC LIMIT 10;
```

### 4. Проверка RLS Политик

```sql
-- Проверить все политики
SELECT
	schemaname,
	tablename,
	policyname,
	permissive,
	roles,
	cmd
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;

-- Проверить включен ли RLS
SELECT
	schemaname,
	tablename,
	rowsecurity
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY tablename;
```

### 5. Функциональное Тестирование

Протестируйте критические функции приложения:

- ✅ Авторизация пользователей
- ✅ Создание проверок
- ✅ Загрузка файлов
- ✅ Оценка работ (AI evaluation)
- ✅ История использования
- ✅ Платежи через Т-Банк
- ✅ Dashboard статистика
- ✅ API endpoints

---

## Мониторинг После Обновления

### Первый День

Внимательно мониторьте:

1. **Логи ошибок**:
   - Supabase Dashboard → Logs → Error Logs
   - Проверяйте каждый час

2. **Производительность**:
   - Время ответа API
   - Скорость запросов к БД
   - CPU и Memory usage

3. **Пользовательские жалобы**:
   - Мониторьте feedback
   - Проверяйте сообщения об ошибках

### Первая Неделя

1. Запустите полный набор тестов
2. Проверьте аналитику производительности
3. Сравните метрики до/после обновления

---

## План Отката (В Случае Проблем)

### Если возникли критические проблемы:

#### Вариант 1: Откат через Support

1. **Немедленно создайте ticket** в Supabase Support
2. Укажите:
   - Описание проблемы
   - Логи ошибок
   - Запрос на откат к предыдущей версии
3. Supabase команда выполнит откат (обычно 1-2 часа)

#### Вариант 2: Восстановление из Backup

1. Создайте новый Supabase проект
2. Восстановите backup:
   ```bash
   psql "postgresql://postgres:[PASSWORD]@db.[NEW-PROJECT-REF].supabase.co:5432/postgres" < backup_20251019.sql
   ```
3. Обновите connection strings в приложении
4. Переключите DNS/endpoints

---

## Рекомендуемое Время Обновления

**Оптимальное время**:

- **День недели**: Вторник или среда (не пятница!)
- **Время**: 02:00-04:00 по московскому времени
- **Причина**: Минимальная нагрузка на систему

**НЕ обновляйте в**:

- Пятницу (сложно откатить на выходных)
- Праздничные дни
- Периоды высокой нагрузки
- Перед важными дедлайнами

---

## Чек-лист Перед Обновлением

- [ ] Создан полный backup базы данных
- [ ] Протестировано на staging окружении
- [ ] Команда готова к откату (если нужно)
- [ ] Выбрано оптимальное время (низкая нагрузка)
- [ ] Пользователи уведомлены о возможном downtime
- [ ] Подготовлен план тестирования
- [ ] Настроен мониторинг логов и метрик
- [ ] Есть контакт с Supabase Support (если нужно)

---

## Контакты и Ресурсы

- **Supabase Dashboard**: https://app.supabase.com
- **Supabase Support**: https://supabase.com/support
- **Документация по обновлению**: https://supabase.com/docs/guides/platform/upgrading
- **Supabase Status**: https://status.supabase.com
- **Community Discord**: https://discord.supabase.com

---

## Заключение

Обновление PostgreSQL в Supabase — это **безопасная операция** при правильном планировании.

**Ключевые моменты**:

1. ✅ **Всегда создавайте backup**
2. ✅ **Тестируйте на staging**
3. ✅ **Выбирайте правильное время**
4. ✅ **Мониторьте после обновления**
5. ✅ **Имейте план отката**

**Рекомендация**: Выполните обновление в ближайшие 2-4 недели, чтобы получить последние патчи безопасности.

---

*Документ создан: 2025-10-19*
*Автор: Claude (Database Optimization Specialist)*
*Версия: 1.0*
