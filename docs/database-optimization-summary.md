# –ö—Ä–∞—Ç–∫–æ–µ –†–µ–∑—é–º–µ: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î ChecklyTool

**–î–∞—Ç–∞:** 09 –æ–∫—Ç—è–±—Ä—è 2025
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω (–ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ë–î)

---

## –û–±—â–∞—è –û—Ü–µ–Ω–∫–∞: 6.5/10

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û—Ü–µ–Ω–∫–∞ | –°—Ç–∞—Ç—É—Å |
|-----------|--------|--------|
| –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ö–µ–º—ã | 8/10 | ‚úÖ –•–æ—Ä–æ—à–æ |
| –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ | 6/10 | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è |
| RLS –ø–æ–ª–∏—Ç–∏–∫–∏ | 4/10 | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | 7/10 | ‚ö†Ô∏è –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω—É–∂–Ω–∞ |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | 5/10 | üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å | 6/10 | ‚ö†Ô∏è –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω—É–∂–Ω–∞ |

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ü—Ä–æ–±–ª–µ–º—ã (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –ù–ï–ú–ï–î–õ–ï–ù–ù–û)

### 1. RLS –æ—Ç–∫–ª—é—á–µ–Ω –Ω–∞ `payment_orders`
**–†–∏—Å–∫:** –õ—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —á—É–∂–∏–µ –ø–ª–∞—Ç–µ–∂–∏
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç
```sql
ALTER TABLE public.payment_orders ENABLE ROW LEVEL SECURITY;
```

### 2. –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ RLS –Ω–∞ `user_profiles`
**–†–∏—Å–∫:** –õ—é–±–æ–π –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á—É–∂–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏
**–í—Ä–µ–º—è:** 1 —á–∞—Å
```sql
-- –î–≤–µ –ø–æ–ª–∏—Ç–∏–∫–∏ "Allow all operations" —Ä–∞–∑—Ä–µ—à–∞—é—Ç –í–°–Å –≤—Å–µ–º!
DROP POLICY "Allow all operations" ON user_profiles;
```

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ 5 Foreign Keys
**–†–∏—Å–∫:** JOIN –∑–∞–ø—Ä–æ—Å—ã –≤ 50-100 —Ä–∞–∑ –º–µ–¥–ª–µ–Ω–Ω–µ–µ
**–í—Ä–µ–º—è:** 30 –º–∏–Ω—É—Ç
```sql
CREATE INDEX idx_user_profiles_subscription_plan_id
ON user_profiles(subscription_plan_id);
-- ... –∏ –µ—â–µ 4 –∏–Ω–¥–µ–∫—Å–∞
```

**–û–±—â–µ–µ –≤—Ä–µ–º—è –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2 —á–∞—Å–∞

---

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 1. –î—É–±–ª–∏—Ä—É—é—â–∏–µ RLS –ü–æ–ª–∏—Ç–∏–∫–∏
- –¢–∞–±–ª–∏—Ü–∞ `checks`: 5 –ø–æ–ª–∏—Ç–∏–∫ –≤–º–µ—Å—Ç–æ 1
- –¢–∞–±–ª–∏—Ü–∞ `user_profiles`: 2 –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏
- **–í–ª–∏—è–Ω–∏–µ:** –ö–∞–∂–¥–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- **–ü—Ä–∏—Ä–æ—Å—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 15-20%

### 2. –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ RLS —Å `current_setting()`
- 15 –ø–æ–ª–∏—Ç–∏–∫ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ö–ê–ñ–î–û–ô —Å—Ç—Ä–æ–∫–∏
- –ü—Ä–∏ –≤—ã–±–æ—Ä–∫–µ 1000 –∑–∞–ø–∏—Å–µ–π = 1000 –≤—ã–∑–æ–≤–æ–≤ –≤–º–µ—Å—Ç–æ 1
- **–ü—Ä–∏—Ä–æ—Å—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 30-50%

### 3. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ò–Ω–¥–µ–∫—Å—ã
- 10 –∏–Ω–¥–µ–∫—Å–æ–≤ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
- –ó–∞–Ω–∏–º–∞—é—Ç ~64 KB
- –ó–∞–º–µ–¥–ª—è—é—Ç INSERT/UPDATE –Ω–∞ 5-10%

### 4. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –°–æ—Å—Ç–∞–≤–Ω—ã–µ –ò–Ω–¥–µ–∫—Å—ã
- –ù–µ—Ç `(user_id, created_at)` –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- –ù–µ—Ç `(check_id, status)` –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
- **–ü—Ä–∏—Ä–æ—Å—Ç –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:** 20-40%

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ë–î

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:              7
–ü—Ä–æ–≤–µ—Ä–∫–∏:                  76
–°–∞–±–º–∏—Ç—ã:                  123
–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ü–µ–Ω–∫–∏:         69
–§–∞–π–ª—ã –≤ Storage:          146
–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä:           ~1.5 MB

–í—ã–≤–æ–¥: –ú–∞–ª—ã–π –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–æ—Å—Ç–∞
```

---

## üíæ Self-Hosting: –û—Ü–µ–Ω–∫–∞ –°–ª–æ–∂–Ω–æ—Å—Ç–∏

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã Supabase –≤ –ü—Ä–æ–µ–∫—Ç–µ

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å | –°–ª–æ–∂–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ |
|-----------|--------------|-------------|-------------------|
| PostgreSQL | ‚úÖ –î–∞ | –í—ã—Å–æ–∫–∞—è | –ù–∏–∑–∫–∞—è (8-16 —á) |
| Storage | ‚úÖ –î–∞ | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω—è—è (4-8 —á) |
| Auth (GoTrue) | ‚ùå –ù–µ—Ç | –ù–µ—Ç | - (NextAuth.js) |
| PostgREST | ‚ùå –ù–µ—Ç | –ù–µ—Ç | - |
| Realtime | ‚ùå –ù–µ—Ç | –ù–µ—Ç | - |

### –û–±—â–∞—è –û—Ü–µ–Ω–∫–∞

- **–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è
- **–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã:** 88-104 —á–∞—Å–∞ (11-13 –¥–Ω–µ–π)
- **–†–∏—Å–∫–∏:** –°—Ä–µ–¥–Ω–∏–µ

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

‚ùå **–ù–ï –ú–ò–ì–†–ò–†–û–í–ê–¢–¨ –°–ï–ô–ß–ê–°**

**–ü—Ä–∏—á–∏–Ω—ã:**
- –ú–∞–ª—ã–π –æ–±—ä–µ–º –¥–∞–Ω–Ω—ã—Ö (1.5 MB)
- –ù–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (7 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- Supabase —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–ª–∏—á–Ω–æ
- –≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ DevOps

**–ö–æ–≥–¥–∞ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å:**
- 100+ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –†–∞—Å—Ö–æ–¥—ã Supabase > —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
- –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è 152-–§–ó

---

## ü™£ S3 –æ—Ç reg.ru: –ü–ª–∞–Ω –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –¢–µ–∫—É—â–∞—è –ü—Ä–æ–±–ª–µ–º–∞

```typescript
// –•—Ä–∞–Ω—è—Ç—Å—è –í–†–ï–ú–ï–ù–ù–´–ï signed URLs (–∏—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞!)
submission_images: [
  'https://...supabase.co/...?token=xyz&expires=...'
]

// –ß–µ—Ä–µ–∑ 24 —á–∞—Å–∞ —Å—Å—ã–ª–∫–∏ –ø–µ—Ä–µ—Å—Ç–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å ‚ùå
```

### –†–µ—à–µ–Ω–∏–µ

```typescript
// –•—Ä–∞–Ω–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ü–£–¢–ò
submission_file_paths: [
  'checkId/timestamp-0-photo.jpg'
]

// –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å signed URL –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
const url = await storage.getSignedUrl(path, 3600)
```

### –ü–ª–∞–Ω –ú–∏–≥—Ä–∞—Ü–∏–∏

1. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å S3 bucket** (1 —á–∞—Å)
2. **–°–æ–∑–¥–∞—Ç—å Storage abstraction** (2 —á–∞—Å–∞)
3. **–û–±–Ω–æ–≤–∏—Ç—å API routes** (4 —á–∞—Å–∞)
4. **–ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã –ë–î** (1 —á–∞—Å)
5. **–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ñ–∞–π–ª—ã** (2 —á–∞—Å–∞)
6. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (4 —á–∞—Å–∞)

**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 16 —á–∞—Å–æ–≤

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

‚úÖ –†–æ—Å—Å–∏–π—Å–∫–∏–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä (152-–§–ó)
‚úÖ S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API
‚úÖ –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ URL
‚úÖ –õ–µ–≥–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

---

## üöÄ –ü–ª–∞–Ω –î–µ–π—Å—Ç–≤–∏–π

### –ù–µ–¥–µ–ª—è 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```bash
–î–µ–Ω—å 1-2: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
‚òê –í–∫–ª—é—á–∏—Ç—å RLS –Ω–∞ payment_orders (30 –º–∏–Ω)
‚òê –ò—Å–ø—Ä–∞–≤–∏—Ç—å RLS –Ω–∞ user_profiles (1 —á–∞—Å)
‚òê –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ FK (30 –º–∏–Ω)

–î–µ–Ω—å 3-4: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
‚òê –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (30 –º–∏–Ω)
‚òê –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å current_setting() (2 —á–∞—Å–∞)
‚òê –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã (30 –º–∏–Ω)
‚òê –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã (1 —á–∞—Å)

–î–µ–Ω—å 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚òê –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
‚òê –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
```

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:** Backend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫
**–û–±—â–µ–µ –≤—Ä–µ–º—è:** 8 —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã

---

### –ú–µ—Å—è—Ü 1: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

```bash
–ù–µ–¥–µ–ª—è 2:
‚òê –ò—Å–ø—Ä–∞–≤–∏—Ç—å search_path –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö (1 —á–∞—Å)
‚òê –û–±–Ω–æ–≤–∏—Ç—å PostgreSQL (15 –º–∏–Ω)

–ù–µ–¥–µ–ª—è 3:
‚òê –ò–∑–º–µ–Ω–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Ö—Ä–∞–Ω–µ–Ω–∏—è URL (4 —á–∞—Å–∞)
‚òê –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–ù–µ–¥–µ–ª—è 4:
‚òê –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ë–î
‚òê –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

---

### –ö–≤–∞—Ä—Ç–∞–ª 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é

```bash
–ú–µ—Å—è—Ü 2:
‚òê –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü
‚òê –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

–ú–µ—Å—è—Ü 3:
‚òê –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è S3 –æ—Ç reg.ru
‚òê –ú–∏–≥—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤

–ú–µ—Å—è—Ü 4:
‚òê Cost analysis (Supabase vs Self-Hosted)
‚òê –†–µ—à–µ–Ω–∏–µ –æ self-hosting
```

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü–æ—Å–ª–µ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----|----|-----------|
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å | 5/10 | 9/10 | +80% |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å JOIN | 10 —Å–µ–∫ | 0.1 —Å–µ–∫ | **100x** |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å RLS | 1 —Å–µ–∫ | 0.3 —Å–µ–∫ | **3x** |
| –°–∫–æ—Ä–æ—Å—Ç—å INSERT | 100 –º—Å | 90 –º—Å | +10% |

### –ü–æ—Å–ª–µ –ü–æ–ª–Ω–æ–π –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: 9/10
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 9/10
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å: 8/10
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–æ—Å—Ç—É: 100+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –ó–∞–ø—É—Å–∫–∞

### –ü–µ—Ä–µ–¥ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –ú–∏–≥—Ä–∞—Ü–∏–π

- [ ] –°–æ–∑–¥–∞—Ç—å backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã (EXPLAIN ANALYZE)
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å rollback –ø–ª–∞–Ω

### –ü–æ—Å–ª–µ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏—è

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ API endpoints
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ (1 —á–∞—Å)
- [ ] Performance testing

---

## üîó –°—Å—ã–ª–∫–∏ –Ω–∞ –î–æ–∫—É–º–µ–Ω—Ç—ã

1. **–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç:** `/docs/database-optimization-report.md`
2. **–ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç:** –†–∞–∑–¥–µ–ª 5.2 –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
3. **S3 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** –†–∞–∑–¥–µ–ª 7 –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞

---

## üí° –ì–ª–∞–≤–Ω—ã–µ –í—ã–≤–æ–¥—ã

1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–∞**, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
2. **Self-hosting –ù–ï –Ω—É–∂–µ–Ω —Å–µ–π—á–∞—Å** - Supabase —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç–ª–∏—á–Ω–æ
3. **S3 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–ª–µ–∑–Ω–∞** –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è 152-–§–ó –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
4. **–í—Ä–µ–º—è –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: 8 —á–∞—Å–æ–≤**
5. **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é: –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**

---

## ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ –†–µ–≤—å—é –ö–æ–¥–∞

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:** 09 –æ–∫—Ç—è–±—Ä—è 2025 (–ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞)

### 1. Email –∫–∞–∫ user_id - –ò–∑–º–µ–Ω–µ–Ω–∏–π –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚úÖ

**–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- `user_profiles.user_id` = email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- NextAuth.js v5 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç email –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ `auth.email()`

**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ:**
- ‚ùå –ù–ï –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚ùå –ù–ï –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å NextAuth –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- ‚úÖ –¢–æ–ª—å–∫–æ —É–ª—É—á—à–∏—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫–∏ (–∑–∞–º–µ–Ω–∞ `USING (true)` –Ω–∞ `USING (user_id = auth.email())`)

**–í—ã–≤–æ–¥:** Email –∫–∞–∫ ID - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, –Ω–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

---

### 2. –ü–ª–∞—Ç–µ–∂–Ω–∞—è –°–∏—Å—Ç–µ–º–∞ - –ü–æ–ª–Ω–æ—Å—Ç—å—é –†–∞–±–æ—á–∞—è ‚úÖ

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ –∫–æ–¥–µ:**

‚úÖ **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞** (`/api/payment/init/route.ts`):
- –°–æ–∑–¥–∞–µ—Ç –∑–∞–∫–∞–∑ –≤ `payment_orders`
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `order_id` –∏ `payment_url`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å `pending`

‚úÖ **Webhook –æ—Ç –¢-–ë–∞–Ω–∫–∞** (`/api/payment/webhook/route.ts`):
- –ü–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ –ø–ª–∞—Ç–µ–∂–∞ (—Å—Ç—Ä–æ–∫–∞ 12)
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –Ω–∞ `paid` (—Å—Ç—Ä–æ–∫–∞ 68-74)
- **–ê–ö–¢–ò–í–ò–†–£–ï–¢ –ü–û–î–ü–ò–°–ö–£** (—Å—Ç—Ä–æ–∫–∞ 85-126):
  ```typescript
  // –û–±–Ω–æ–≤–ª—è–µ—Ç user_profiles
  subscription_plan_id: order.plan_id,
  subscription_expires_at: expiresAt,
  check_balance: plan.check_quota
  ```
- –õ–æ–≥–∏—Ä—É–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ `check_usage_history` (—Å—Ç—Ä–æ–∫–∞ 118-123)

‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞** (`/api/payment/status/[orderId]/route.ts`):
- –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –ø–æ `order_id`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ `user_id`

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã:**
```sql
-- –í—Å–µ —ç—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç UNIQUE –∏–Ω–¥–µ–∫—Å –Ω–∞ order_id
WHERE order_id = ?           -- ‚úÖ –ë—ã—Å—Ç—Ä–æ (UNIQUE constraint)
WHERE order_id = ? AND user_id = ?  -- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç

-- –≠—Ç–∏ —Å—Ç–æ–ª–±—Ü—ã –ù–ï –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∏–≥–¥–µ:
WHERE payment_id = ?         -- ‚ùå –ù–ò–ì–î–ï –≤ –∫–æ–¥–µ
WHERE status = ?             -- ‚ùå –ù–ò–ì–î–ï –≤ –∫–æ–¥–µ
```

**–í—ã–≤–æ–¥:** –ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 100%, webhook –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

---

### 3. –¢–∞–±–ª–∏—Ü–∞ payment_orders - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –í–∞–∂–Ω–∞ ‚úÖ

**–í–ê–ñ–ù–û:**
- ‚ùå –¢–∞–±–ª–∏—Ü–∞ `payment_orders` **–ù–ï —É–¥–∞–ª—è–µ—Ç—Å—è**
- ‚ùå –î–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–µ–π **–ù–ï —É–¥–∞–ª—è—é—Ç—Å—è**
- ‚ùå –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ–ø–ª–∞—Ç—ã **–ù–ï –º–µ–Ω—è–µ—Ç—Å—è**

**–ß—Ç–æ –î–ï–ô–°–¢–í–ò–¢–ï–õ–¨–ù–û —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**

‚úÖ **–£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã:**
```sql
-- –≠—Ç–∏ –∏–Ω–¥–µ–∫—Å—ã –ù–ò–ö–û–ì–î–ê –Ω–µ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –≤ –∫–æ–¥–µ
DROP INDEX idx_payment_orders_payment_id;  -- –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
DROP INDEX idx_payment_orders_status;      -- –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
DROP INDEX idx_payment_orders_order_id;    -- –¥—É–±–ª–∏—Ä—É–µ—Ç UNIQUE
```

‚úÖ **–î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –∏–Ω–¥–µ–∫—Å –Ω–∞ FK:**
```sql
CREATE INDEX idx_payment_orders_plan_id
ON payment_orders(plan_id);
```

‚úÖ **–í–∫–ª—é—á–∏—Ç—å RLS (–ö–†–ò–¢–ò–ß–ù–û!):**
```sql
ALTER TABLE payment_orders ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own payment orders"
ON payment_orders FOR SELECT
USING (user_id = (SELECT auth.email()));
```

**–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- ‚úÖ Webhook –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç UNIQUE –Ω–∞ `order_id`)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- ‚úÖ INSERT —Å—Ç–∞–Ω–µ—Ç –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ 5-10%
- ‚úÖ –ü–ª–∞—Ç–µ–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞—â–∏—â–µ–Ω—ã RLS

**–í—ã–≤–æ–¥:** –ü–ª–∞—Ç–µ–∂–Ω—ã–π –≤–∏–¥–∂–µ—Ç –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–º, —Ç–æ–ª—å–∫–æ —Å—Ç–∞–Ω–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –∏ –±—ã—Å—Ç—Ä–µ–µ.

---

### 4. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ò–Ω–¥–µ–∫—Å–æ–≤ - –ì–∞—Ä–∞–Ω—Ç–∏—è 100% ‚úÖ

**–ü–æ—á–µ–º—É —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ:**

–ò–Ω–¥–µ–∫—Å—ã - —ç—Ç–æ **—É—Å–∫–æ—Ä–∏—Ç–µ–ª–∏ –ø–æ–∏—Å–∫–∞**, –∞ –Ω–µ –¥–∞–Ω–Ω—ã–µ:
- ‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –ù–ï —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
- ‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –ù–ï –º–µ–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–µ—Å—Ç–æ
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ —É—Å–∫–æ—Ä—è–µ—Ç INSERT/UPDATE

**–ê–Ω–∞–ª–æ–≥–∏—è:**
–≠—Ç–æ –∫–∞–∫ —É–¥–∞–ª–∏—Ç—å –∑–∞–∫–ª–∞–¥–∫–∏ –∏–∑ –∫–Ω–∏–≥–∏, –∫–æ—Ç–æ—Ä—ã–º–∏ –≤—ã –Ω–µ –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å - —Å–∞–º —Ç–µ–∫—Å—Ç –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ.

**–í –±—É–¥—É—â–µ–º:**
–ï—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –∏–Ω–¥–µ–∫—Å –Ω–∞ `payment_id` –∏–ª–∏ `status`, –µ–≥–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞ 1 –º–∏–Ω—É—Ç—É:
```sql
CREATE INDEX idx_payment_orders_status ON payment_orders(status);
```

**–í—ã–≤–æ–¥:** –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ - –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è.

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ 5.2 –ø–æ–ª–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞

**–ö–æ–Ω—Ç–∞–∫—Ç:** Claude (Database Optimization Specialist)
